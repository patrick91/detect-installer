name: Tests
on: [push, pull_request]
jobs:
  tests:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: false
      - name: Install pipx
        run: uv tool install pipx
      - name: Install brew Python (macOS only)
        if: runner.os == 'macOS'
        run: brew install python@3.12 || true
      - run: uv run coverage run -m pytest tests/ -v
      - name: Upload coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-data-${{ matrix.os }}
          path: .coverage.*
          include-hidden-files: true
          if-no-files-found: ignore

  coverage:
    name: Combine & check coverage
    if: always()
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - uses: actions/download-artifact@v4
        with:
          pattern: coverage-data-*
          merge-multiple: true
      - name: Combine coverage & check
        run: |
          uv run coverage combine
          uv run coverage html --skip-covered --skip-empty
          uv run coverage report --format=markdown >> $GITHUB_STEP_SUMMARY
          uv run coverage report --fail-under=100

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: j178/prek-action@v1
